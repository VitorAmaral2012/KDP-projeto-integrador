#include <Servo.h>
#include <Key.h>
#include <Keypad.h>


#define PServo1 2
#define PServo2 3
#define PServo3 4
#define MOTOR 5
#define SensorMotor 14
#define SensorVermelho 15
#define SensorVerde 17
#define SensorAzul 16

#define BlueANGMAX 180
#define BlueANGMED 145
#define BlueANGMIN 110
#define GreenANGMIN 0 //70
#define GreenANGMED 35
#define GreenANGMAX 70
#define RedANGMIN 40
#define RedANGMED 75
#define RedANGMAX 110

Servo servos[4];
byte Colum[4] = {13, 12, 11, 10};
byte Linha[4] = {9, 8, 7, 6};
char Teclado[4][4] = {  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'},
};
Keypad KeyPad = Keypad(makeKeymap(Teclado), Colum, Linha, 4, 4);

unsigned long Start_program_timer;
unsigned long Start_motor_timer;
unsigned long Current_motor_timer;

String Comando;

void setup() {
  Serial.begin(9600);

  pinMode(MOTOR, OUTPUT);
  digitalWrite(MOTOR, LOW);
  delay(400);
  pinMode(PServo1, OUTPUT);
  servos[0].attach(PServo1);
  servos[0].write(BlueANGMIN);
  delay(500);

  pinMode(PServo2, OUTPUT);
  servos[1].attach(PServo2);
  servos[1].write(GreenANGMIN);
  delay(500);

  pinMode(PServo3, OUTPUT);
  servos[2].attach(PServo3);
  servos[2].write(RedANGMIN);

  pinMode(SensorMotor, INPUT); // put your setup code here, to run once:
  pinMode(SensorVerde, INPUT);
  pinMode(SensorVermelho, INPUT);
  pinMode(SensorAzul, INPUT);
}

void  LigarServo(int Set, int AnguloFinal, int AnguloDeParada) {

  int i;
  Serial.println(servos[Set].read());
  if (AnguloFinal > servos[Set].read()) {
    Serial.println("UP");
    for (i = servos[Set].read(); i <= AnguloFinal; i += 5) {
      servos[Set].write(i);
      delay(20);
    }

  } else {
    Serial.println("Down");
    for (i = servos[Set].read(); i >= AnguloDeParada; i -= 5) {
      servos[Set].write(i);
      delay(20);
    }
  }
}


bool printSensor(int PIN, String cor) {
  delay(50);
  if (digitalRead(PIN) == 1) {
    Serial.println(cor + " OK");
    return false;
  }
  Serial.println(cor + " OFF");
  return true;

}

void StartProgma() {
  Start_program_timer = millis();
  if (Start_program_timer < 1500) {

    Serial.println("Coloque os 3 kits iniciais:");
    
    do{
      printSensor(SensorVermelho, "Red");
      delay(100);
      printSensor(SensorVerde, "Green");
      delay(100);
      printSensor(SensorAzul, "Blue");
      delay(1000);
      Serial.println("----------------------");
    }while (digitalRead(SensorVermelho) || digitalRead(SensorVerde)||  digitalRead(SensorVermelho));
  }
}


void LigarEsteira(){
  Start_motor_timer = millis();
  digitalWrite(MOTOR, HIGH);
  while (digitalRead(SensorMotor) &&  Current_motor_timer <= Start_motor_timer + 6000) {
    Current_motor_timer = millis();
  }
  digitalWrite(MOTOR, LOW);
  }


void loop() {
  StartProgma();
  char chave = KeyPad.waitForKey();
  if (chave == 'A' ) {
    Serial.println("A");
     if(printSensor(SensorAzul, "Blue")){
    delay(50);
    LigarServo(0, BlueANGMAX, BlueANGMIN);
    delay(1500);
    LigarServo(0, BlueANGMAX, BlueANGMIN);
     delay(50);
    LigarEsteira();
    }
   
  }
  if (chave == 'C') {
      if( printSensor(SensorVerde, "Green")){
    Serial.println("C");
    delay(50);
    LigarServo(1, GreenANGMAX, GreenANGMIN);
    delay(1500);
    LigarServo(1, GreenANGMAX, GreenANGMIN);
      delay(50);
    LigarEsteira();
    }
   
  }

  if (chave == 'B') {
     if(printSensor(SensorVermelho, "Red")){
    Serial.println("B");
    delay(50);
    LigarServo(2, RedANGMAX, RedANGMIN);
    delay(1500);
    LigarServo(2, RedANGMAX, RedANGMIN);
      delay(50);
    LigarEsteira();}
   
  }
  
}
